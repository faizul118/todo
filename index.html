<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Murgi's Todo</title>
  <style>
    :root{--bg:#fff;--muted:#666;--accent:#0b63ff}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
    body{display:flex;gap:18px;padding:18px;background:var(--bg);color:#111}
    .pane{background:#f8f9fb;border-radius:12px;padding:12px;box-shadow:0 6px 20px rgba(15,15,15,0.04)}
    .left{width:300px;min-width:220px;max-height:calc(100vh - 36px);overflow:auto}
    .right{flex:1;display:flex;flex-direction:column;min-height:400px}
    h1{font-size:18px;margin:0 0 8px}
    .controls{display:flex;gap:8px;margin-bottom:8px}
    input[type="text"], input[type="password"]{padding:8px;border-radius:8px;border:1px solid #ddd;flex:1}
    button{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer}
    button.ghost{background:transparent;color:var(--accent);border:1px solid #e6eefc}
    ul{list-style:none;padding:0;margin:8px 0}
    li{padding:8px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
    li:hover{background:rgba(11,99,255,0.06)}
    .filename{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .status{font-weight:600;margin-bottom:8px}
    textarea{width:100%;height:calc(100vh - 240px);resize:vertical;padding:12px;border-radius:8px;border:1px solid #e6e6e6;font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
    .meta{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .small{font-size:13px;color:var(--muted)}
    .error{color:#b00020}
    .ok{color:green}
    .modified{color:orange}
    .file-actions{display:flex;gap:8px}
    .hidden{display:none}
    @media (max-width:760px){body{flex-direction:column}.left{width:100%;max-height:220px}.right{min-height:300px}}
    code{background:#fff1c6;padding:2px 6px;border-radius:4px}
  </style>
</head>
<body>
  <div class="pane left">
    <h1>Projects</h1>
    <div class="controls">
      <input id="newProjectName" placeholder="project name (ascii, no spaces)" type="text" />
      <button id="createProject">New</button>
    </div>
    <div class="small" style="margin-bottom:8px">
      Tip: only the base name is needed — you don't need to type <code>todo_</code> or <code>.txt</code>.
    </div>

    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      <button id="refreshList" class="ghost">Refresh</button>
      <span class="small">Files starting with <code>todo_</code></span>
    </div>
    <ul id="fileList" aria-live="polite"></ul>
    <div class="small" style="margin-top:8px;color:var(--muted)">Tip: open directly with <code>?file=that</code> (base name) or <code>?file=todo_that.txt</code>.</div>
  </div>

  <div class="pane right">
    <div class="meta">
      <input id="password" type="password" placeholder="GitHub PAT (optional)" />
      <label style="display:flex;align-items:center;gap:8px;font-size:14px;margin-left:8px">
        <input id="rememberPassword" type="checkbox" /> <span>Remember password</span>
      </label>

      <div style="flex:1"></div>
      <div class="file-actions">
        <button id="commitNotes">Commit</button>
        <button id="download" class="ghost">Download</button>
      </div>
    </div>

    <div class="status" id="status"></div>
    <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
      <div class="small">Editing: <b id="currentFile">(none)</b></div>
      <div class="small">SHA: <span id="fileSha">-</span></div>
    </div>

    <div id="editorArea">
      <textarea spellcheck="false" id="notes" placeholder="Open or create a todo_ file..."></textarea>
    </div>

    <div id="emptyState" class="small" style="padding:24px;text-align:center;display:none">
      <p style="font-size:16px;margin:0 0 12px">No file open — create a new todo file to get started.</p>
      <input id="emptyName" placeholder="name (e.g. myproject)" style="padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:8px;width:60%" />
      <div class="small" style="margin-bottom:8px">Tip: only the base name is needed — you don't need to type <code>todo_</code> or <code>.txt</code>. ASCII only, no spaces.</div>
      <div><button id="createProjectEmpty">Create</button></div>
    </div>
  </div>

  <script>
    // ------------------ CONFIG -------------------
    const OWNER = 'faizul118';
    const REPO = 'todo';
    const API_BASE = `https://api.github.com/repos/${OWNER}/${REPO}/contents`;
    const BASE_TITLE = "Murgi's Todo";
    const SAVED_KEY = 'murgi_todo_saved_password';
    const LAST_FILE_KEY = 'murgi_todo_last_file';

    // beforeunload handler to prevent closing when there are unsaved changes
    function beforeUnloadHandler(e){
      e.preventDefault();
      e.returnValue = '';
    }

    function setUnsavedFlag(unsaved){
      if(unsaved){
        if(!document.title.startsWith('• ')) document.title = '• ' + BASE_TITLE;
        window.addEventListener('beforeunload', beforeUnloadHandler);
      } else {
        document.title = BASE_TITLE;
        window.removeEventListener('beforeunload', beforeUnloadHandler);
      }
    }
    // initialize title
    document.title = BASE_TITLE;

    // helpers
    function getBaseName(fileName){
      if(!fileName) return '';
      if(fileName.startsWith('todo_')) fileName = fileName.slice(5);
      if(fileName.endsWith('.txt')) fileName = fileName.slice(0, -4);
      return fileName;
    }

    function makeFullFilename(input){
      if(!input) return null;
      let name = input.trim();
      if(name.startsWith('todo_') && name.endsWith('.txt')) return name;
      if(name.startsWith('todo_')) name = name.slice(5);
      if(name.endsWith('.txt')) name = name.slice(0, -4);
      // allow only ascii letters, numbers, hyphen and underscore, no spaces
      if(!/^[A-Za-z0-9_-]+$/.test(name)) return null;
      return 'todo_' + name + '.txt';
    }

    // Unicode-safe base64 helpers
    function b64EncodeUnicode(str){
      return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1){
        return String.fromCharCode('0x' + p1);
      }));
    }
    function b64DecodeUnicode(b64){
      return decodeURIComponent(Array.prototype.map.call(atob(b64), function(c){
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
    }

    // DOM
    const fileListEl = document.getElementById('fileList');
    const newProjectNameInput = document.getElementById('newProjectName');
    const createProjectBtn = document.getElementById('createProject');
    const refreshListBtn = document.getElementById('refreshList');
    const notesTextarea = document.getElementById('notes');
    const commitNotesButton = document.getElementById('commitNotes');
    const passwordInput = document.getElementById('password');
    const statusMessage = document.getElementById('status');
    const currentFileEl = document.getElementById('currentFile');
    const fileShaEl = document.getElementById('fileSha');
    const downloadBtn = document.getElementById('download');
    const rememberCheckbox = document.getElementById('rememberPassword');

    let fileSha = '';
    let currentFile = null;
    let originalContent = '';

    function setStatus(text, className){
      statusMessage.textContent = text || '';
      statusMessage.className = className || '';
    }

    // Read query params; if password present, populate and remove from URL
    function getQueryParams(){
      const params = new URLSearchParams(window.location.search);
      const password = params.get('password');
      const file = params.get('file');
      if(password){
        passwordInput.value = password;
        // remove password param but keep others
        params.delete('password');
        const newQs = params.toString();
        const newUrl = window.location.pathname + (newQs ? '?' + newQs : '');
        window.history.replaceState({}, document.title, newUrl);
      }
      return {file};
    }

    async function listTodoFiles(){
      setStatus('⏳ Loading file list...');
      fileListEl.innerHTML = '';
      try{
        const headers = {'Accept':'application/vnd.github.v3+json'};
        if(passwordInput.value) headers['Authorization'] = `Bearer ${passwordInput.value}`;
        const resp = await fetch(API_BASE + '/', {headers});
        if(!resp.ok){
          setStatus('❎ Error listing repo: ' + resp.status + ' ' + resp.statusText, 'error');
          return;
        }
        const data = await resp.json();
        const todos = data.filter(item => item.type === 'file' && item.name && item.name.startsWith('todo_'))
                           .sort((a,b)=>a.name.localeCompare(b.name, undefined, {sensitivity:'base'}));
        if(todos.length === 0){
          const li = document.createElement('li'); li.textContent = '(no todo_ files)'; li.classList.add('small'); fileListEl.appendChild(li);
        }
        for(const file of todos){
          const li = document.createElement('li');
          const span = document.createElement('span'); span.className='filename'; span.textContent = getBaseName(file.name) + '.txt';
          li.appendChild(span);
          const meta = document.createElement('span'); meta.className='small'; meta.textContent = file.sha ? file.sha.slice(0,7) : '';
          li.appendChild(meta);
          li.addEventListener('click', ()=>{ openFile(file.name); });
          fileListEl.appendChild(li);
        }
        setStatus('✅ File list loaded', 'ok');
      }catch(err){
        console.error(err);
        setStatus('❎ Network or unknown error while listing files', 'error');
      }
    }

    async function openFile(fileName){
      if(!fileName) return;
      // accept a base name like "that" as well
      let target = fileName;
      if(!/^todo_[^\\s]+\\.txt$/.test(target) && !/^todo_[^\\s]+$/.test(target) && !/\\.txt$/.test(target)){
        // maybe user provided base name like "that"
        const full = makeFullFilename(target);
        if(full) target = full;
      } else if(!/^todo_/.test(target) || !/\\.txt$/.test(target)){
        // normalize cases like "that.txt" or "todo_that"
        const full = makeFullFilename(target);
        if(full) target = full;
      }

      setStatus('⏳ Fetching ' + target + '...');
      try{
        const headers = {'Accept':'application/vnd.github.v3+json'};
        if(passwordInput.value) headers['Authorization'] = `Bearer ${passwordInput.value}`;
        const resp = await fetch(`${API_BASE}/${encodeURIComponent(target)}`, {headers});
        if(resp.status === 404){
          currentFile = null; fileSha=''; currentFileEl.textContent='(none)'; fileShaEl.textContent='-'; notesTextarea.value=''; originalContent='';
          setStatus('❎ Not found: ' + target, 'error');
          // update url so user can see failure (use base)
          const params = new URLSearchParams(window.location.search);
          params.set('file', getBaseName(target));
          window.history.pushState({}, document.title, window.location.pathname + '?' + params.toString());
          updateUIForFileOpen(false);
          return;
        }
        if(!resp.ok){
          setStatus('❎ Error fetching file: ' + resp.status + ' ' + resp.statusText, 'error');
          return;
        }
        const data = await resp.json();
        const content = data.content ? b64DecodeUnicode(data.content.replace(/\n/g,'')) : '';
        notesTextarea.value = content;
        originalContent = content;
        fileSha = data.sha;
        currentFile = data.name;
        currentFileEl.textContent = getBaseName(currentFile) + '.txt';
        fileShaEl.textContent = fileSha.slice(0,12);
        setStatus('✅ Loaded ' + currentFile, 'ok');
        // update url with base name
        const params = new URLSearchParams(window.location.search);
        params.set('file', getBaseName(currentFile));
        window.history.pushState({}, document.title, window.location.pathname + '?' + params.toString());
        try{ localStorage.setItem(LAST_FILE_KEY, currentFile); }catch(e){}
        setUnsavedFlag(false);
        updateUIForFileOpen(true);
      }catch(err){
        console.error(err);
        setStatus('❎ Unknown error while opening file', 'error');
      }
    }

    async function createProject(){
      let input = newProjectNameInput.value.trim();
      if(!input){ input = prompt('Project name:'); if(!input) return; }
      // normalize to full filename and validate
      const full = makeFullFilename(input);
      if(!full){
        setStatus('❎ Invalid name — use ASCII letters, numbers, hyphen or underscore, no spaces', 'error');
        return;
      }
      let name = full;

      // create empty file
      setStatus('⏳ Creating ' + name + '...');
      try{
        const headers = {'Content-Type':'application/json','Accept':'application/vnd.github.v3+json'};
        if(passwordInput.value) headers['Authorization'] = `Bearer ${passwordInput.value}`;
        const body = JSON.stringify({message: 'Create ' + name, content: b64EncodeUnicode('')});
        const resp = await fetch(`${API_BASE}/${encodeURIComponent(name)}`, {method:'PUT', headers, body});
        if(resp.status === 201 || resp.ok){
          const data = await resp.json();
          fileSha = data.content.sha;
          currentFile = data.content.name;
          currentFileEl.textContent = getBaseName(currentFile) + '.txt';
          fileShaEl.textContent = fileSha.slice(0,12);
          notesTextarea.value = '';
          originalContent = '';
          setStatus('✅ Created ' + currentFile, 'ok');
          try{ localStorage.setItem(LAST_FILE_KEY, currentFile); }catch(e){}
          await listTodoFiles();
          openFile(currentFile);
        } else {
          const txt = await resp.text();
          setStatus('❎ Create failed: ' + resp.status + ' ' + resp.statusText + ' - ' + txt, 'error');
        }
      }catch(err){
        console.error(err);
        setStatus('❎ Unknown error creating project', 'error');
      }
    }

    async function commitNotes(){
      if(!currentFile){ setStatus('⚠️ No file open to commit', 'error'); return; }
      const notes = notesTextarea.value;
      if(notes === originalContent){ setStatus('⚠️ Nothing to commit', 'modified'); return; }
      setStatus('⏳ Committing ' + currentFile + '...');
      try{
        const headers = {'Content-Type':'application/json','Accept':'application/vnd.github.v3+json'};
        if(passwordInput.value) headers['Authorization'] = `Bearer ${passwordInput.value}`;
        const payload = {message: 'Update ' + currentFile, content: b64EncodeUnicode(notes)};
        if(fileSha) payload.sha = fileSha;
        const resp = await fetch(`${API_BASE}/${encodeURIComponent(currentFile)}`, {method:'PUT', headers, body: JSON.stringify(payload)});
        if(!resp.ok){
          const txt = await resp.text();
          setStatus('❎ Commit failed: ' + resp.status + ' ' + resp.statusText + ' - ' + txt, 'error');
          return;
        }
        const data = await resp.json();
        fileSha = data.content.sha;
        fileShaEl.textContent = fileSha.slice(0,12);
        originalContent = notes;
        setStatus('✅ Commit OK', 'ok');
        // save password if asked
        try{
          const rem = document.getElementById('rememberPassword');
          if(rem && rem.checked && passwordInput.value){
            localStorage.setItem(SAVED_KEY, passwordInput.value);
          }
        }catch(e){ console.warn('save password failed', e); }
        // remember last file
        try{ if(currentFile) localStorage.setItem(LAST_FILE_KEY, currentFile); }catch(e){}
        setUnsavedFlag(false);
        await listTodoFiles();
      }catch(err){
        console.error(err);
        setStatus('❎ Unknown error committing file', 'error');
      }
    }

    // Download current content as file
    function downloadCurrent(){
      if(!currentFile) return alert('No file open');
      const blob = new Blob([notesTextarea.value], {type:'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download = getBaseName(currentFile) + '.txt'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // Toggle checkboxes keyboard shortcut (Alt + ArrowRight)
    function handleCheckboxToggle(event){
      if(event.altKey && event.key === 'ArrowRight'){
        event.preventDefault();
        const textarea = notesTextarea;
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const lines = textarea.value.split('\n');
        let currentLineIndex = textarea.value.substring(0, start).split('\n').length - 1;
        let currentLine = lines[currentLineIndex];
        let cursorShift = 0;

        if (currentLine.startsWith('[ ] ')) {
          lines[currentLineIndex] = `[x] ${currentLine.substring(4)}`;
          cursorShift = 0;
        } else if (currentLine.startsWith('[x] ')) {
          lines[currentLineIndex] = currentLine.substring(4);
          cursorShift = -4;
        } else {
          lines[currentLineIndex] = `[ ] ${currentLine}`;
          cursorShift = 4;
        }

        textarea.value = lines.join('\n');

        const newLineStart = textarea.value.split('\n').slice(0, currentLineIndex).join('\n').length + (currentLineIndex > 0 ? 1 : 0);
        let newCursorPos = start + cursorShift;
        const lineLength = lines[currentLineIndex].length;
        if (start === newLineStart) {
          newCursorPos = start + 4;
        } else if (start === newLineStart + lineLength - cursorShift) {
          newCursorPos = start + cursorShift;
        }

        textarea.setSelectionRange(newCursorPos, newCursorPos);
        textarea.dispatchEvent(new Event('input'));
      }
    }

    // Transform '-' or '*' at start of a new line into a bullet when space is pressed.
    function handleBulletTransform(e){
      if(e.key !== ' ') return;
      const textarea = notesTextarea;
      const pos = textarea.selectionStart;
      const lineStart = textarea.value.lastIndexOf('\n', pos-1) + 1;
      const before = textarea.value.substring(lineStart, pos);
      // match: optional indentation, optional backslash, then a single - or * as the last char
      const m = before.match(/^(\s*)(\\?)([-*])$/);
      if(!m) return;
      e.preventDefault();
      const indent = m[1];
      const escaped = m[2] === '\\';
      const sym = m[3];

      if(escaped){
        // remove the escaping backslash and insert the literal symbol + space
        const newLineStart = indent + sym + ' ';
        const newValue = textarea.value.slice(0, lineStart) + newLineStart + textarea.value.slice(pos);
        const newPos = lineStart + newLineStart.length;
        textarea.value = newValue;
        textarea.setSelectionRange(newPos, newPos);
        textarea.dispatchEvent(new Event('input'));
        return;
      }

      // replace the symbol with a bullet char
      const bullet = '•';
      const newLine = indent + bullet + ' ';
      const newValue = textarea.value.slice(0, lineStart) + newLine + textarea.value.slice(pos);
      const newPos = lineStart + newLine.length;
      textarea.value = newValue;
      textarea.setSelectionRange(newPos, newPos);
      textarea.dispatchEvent(new Event('input'));
    }

    // Tab insertion and smart backspace behavior:
    // - Pressing Tab inserts four literal spaces.
    // - Pressing Backspace when immediately after 4 spaces removes them as a unit.
    function handleTabAndBackspace(e){
      const textarea = notesTextarea;
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;

      // Handle Tab key: insert four literal spaces
      if(e.key === 'Tab'){
        e.preventDefault();
        if(typeof e.stopImmediatePropagation === 'function') try{ e.stopImmediatePropagation(); }catch(err){}
        e.stopPropagation();
        const spaces = '    ';
        const before = textarea.value.slice(0, start);
        const after = textarea.value.slice(end);
        // Insert exactly four spaces
        textarea.value = before + spaces + after;
        const pos = start + spaces.length;
        textarea.setSelectionRange(pos, pos);
        textarea.dispatchEvent(new Event('input'));
        return;
      }

      // Smart backspace: if cursor is right after exactly 4 spaces, remove them as a unit
      if(e.key === 'Backspace' && start === end && start > 0){
        const prev4 = textarea.value.slice(Math.max(0, start - 4), start);
        if(prev4 === '    '){
          e.preventDefault();
          if(typeof e.stopImmediatePropagation === 'function') try{ e.stopImmediatePropagation(); }catch(err){}
          e.stopPropagation();
          const before = textarea.value.slice(0, start - 4);
          const after = textarea.value.slice(end);
          textarea.value = before + after;
          textarea.setSelectionRange(start - 4, start - 4);
          textarea.dispatchEvent(new Event('input'));
          return;
        }
      }
    }

    // input change -> mark modified + update title unsaved flag
    notesTextarea.addEventListener('input', () => {
      const unsaved = notesTextarea.value !== originalContent;
      if(unsaved){
        setStatus('✏️ Unsaved changes', 'modified');
      } else {
        setStatus('');
      }
      setUnsavedFlag(unsaved);
    });

    // keyboard shortcuts
    notesTextarea.addEventListener('keydown', handleCheckboxToggle);
    notesTextarea.addEventListener('keydown', handleBulletTransform);
    notesTextarea.addEventListener('keydown', handleTabAndBackspace);

    // Ctrl/Cmd+S to save -> trigger commit button
    window.addEventListener('keydown', (e)=>{
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase() === 's'){
        e.preventDefault();
        if(typeof commitNotesButton !== 'undefined' && commitNotesButton){
          commitNotesButton.click();
        } else {
          commitNotes();
        }
      }
    });

    // UI actions
    createProjectBtn.addEventListener('click', createProject);
    refreshListBtn.addEventListener('click', listTodoFiles);
    commitNotesButton.addEventListener('click', commitNotes);
    downloadBtn.addEventListener('click', downloadCurrent);

    const createEmptyBtn = document.getElementById('createProjectEmpty');
    if(createEmptyBtn){
      createEmptyBtn.addEventListener('click', ()=>{
        const v = document.getElementById('emptyName')?.value?.trim();
        if(v) newProjectNameInput.value = v;
        createProject();
      });
    }

    // remember password checkbox behavior + restore saved password
    try{
      const saved = localStorage.getItem(SAVED_KEY);
      if(saved && passwordInput){
        passwordInput.value = saved;
        if(rememberCheckbox) rememberCheckbox.checked = true;
      }
      if(rememberCheckbox){
        rememberCheckbox.addEventListener('change', (ev)=>{
          if(!ev.target.checked){ localStorage.removeItem(SAVED_KEY); }
        });
      }
    }catch(e){ console.warn('could not access localStorage', e); }

    // When popstate (back/forward) - reload file param
    window.addEventListener('popstate', ()=>{
      const params = new URLSearchParams(window.location.search);
      const f = params.get('file');
      if(f) openFile(f);
    });

    function updateUIForFileOpen(isOpen){
      const editorArea = document.getElementById('editorArea');
      const emptyState = document.getElementById('emptyState');
      if(editorArea && emptyState){
        editorArea.hidden = !isOpen;
        emptyState.hidden = isOpen;
        if(!isOpen){
          currentFileEl.textContent = '(none)';
        }
      }
    }

    // On load
    (async function(){
      const {file} = getQueryParams();
      await listTodoFiles();
      if(file){ openFile(file); return; }
      // if there's a last file recorded in localStorage, open it
      try{ const last = localStorage.getItem(LAST_FILE_KEY); if(last){ openFile(last); return; } }catch(e){}
      // show empty state (no file open)
      updateUIForFileOpen(false);
    })();

  </script>
</body>
</html>
